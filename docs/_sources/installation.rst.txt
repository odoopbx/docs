============
Installation
============

.. toctree::

.. sidebar:: Optional Sidebar Title
   :subtitle: Optional Sidebar Subtitle

   Subsequent indented lines comprise
   the body of the sidebar, and are
   interpreted as body elements.    

OdooPBX installation is managed by the Agent as the Agent is not only the connection middleware but also a deployment manager.

Depending on your current configuration, the following installation types can be reviewed. 

* **Demo setup** - Odoo, The OdooPBX Agent, Asterisk/FreePBX.
* **The Agent setup** - You have both Odoo and Asterisk/FreePBX up and running.
* **PBX setup** - You have only Odoo and require a PBX setup (Asterisk/FreePBX)
* **Odoo setup** You have Asterisk/FreePBX and require Odoo/CRM setup.

These configurations differ only in a set of installed components.

Also there are two deployment types:

* **Docker** based deployment.
* **Direct** host setup.

Let's review these options in details.

Docker based deployment
=======================
See the ``docker`` folder in Agent repository `here <https://github.com/odoopbx/agent/tree/master/docker>`_.

We use docker compose to define and run the OdooPBX services. The following services are defined:

* **db** - PostgreSQL database used by Odoo.
* **odoo** - Odoo server.
* **agent** - Salt processes (salt-master, salt-minion, salt-api).
* **asterisk** - a plain Asterisk PBX with minimal set of configuration files.
* **freepbx** - We use `tiredofit/freepbx <https://github.com/tiredofit/docker-freepbx>`_ - 
  the most popular FreePBX image published on the docker.hub. *Disclaimer: we do not maintain this FreePBX image.
  You can replace it with any other FreePBX docker image of your choice.* 

You can take an example ``docker-compose.yml`` file to get demo up & running `here <https://github.com/odoopbx/docker/blob/master/docker-compose.yml>`_.

Also please note the ``docker-compose.override.yml`` example on how to customize the defaults: `here <https://github.com/odoopbx/docker/blob/master/docker-compose.override.yml.example>`_.

So depending on your requered setup you can choose which services to run.

Direct installation
===================
We use Salt states files to install different OdooPBX components. The following components are available:

* **odoo** - Odoo server.
* **postgres** - PostgreSQL database.
* **agent** - Salt minion, api and master processes.
* **asterisk** - Asterisk PBX server.

To install a compoment the following command is used:

.. code:: sh

    salt-call state.apply agent
    salt-call state.apply postgres

To install all compoments use this:

.. code:: sh

    salt-call state.apply odoopbx

Demo setup
==========
The easiest and fastest way to start using OdooPBX is the docker based installation. Full demo is available for direct setup only with Asterisk (direct setup does not 
install FreePBX currently).

Run either Asterisk or FrePBX service.

.. code:: sh

    docker-compose up odoo agent freepbx


The Agent setup
===============
This setup assumes that both Odoo and Asterisk are already installed and running.

When Odoo & Asterisk / FreePBX exists you require only the OdooPBX Agent
setup (Agent is a middleware between Odoo & Asterisk).

Docker setup
############

To deploy the Agent in docker use this:

.. code:: sh

  docker-compose up -d agent

Also you have to provide your custom Odoo & Asterisk settings. This is done by using a volume mapping
in your ``docker-compose.override.yml``:

.. code:: yml

    version: '3.1'
    services:

    minion:    
    volumes:
      - ./minion_local.conf:/etc/salt/minion_local.conf

So this maps ``minion_local.conf`` that will be automatically included by the minion.

Below is an example of custom options. See the full list of possible options - :doc:`agent_options`.

``minion_local.conf``:

.. code:: yml

    odoo_db: my_database
    odoo_password: asterisk1password
    odoo_port: 443
    odoo_use_ssl: True
    ami_login: odoo
    ami_secret: dfghj5678b
    ami_port: 5038
    ami_host: asterisk.host

Direct setup
############
The best place to install the Agent is the same server where Asterisk is running because in this case
it has direct access to local file system  and can access call recordings. 

If you don't need call recordings in Odoo you can setup the Asterisk agent on a different computer but
it is advised to place it near the Asterisk server.

.. note:: 
    Please note that the Agent requires root privileges. The commands below must be run as the **root** user.

Installation on Ubuntu and Debian
+++++++++++++++++++++++++++++++++

.. code::

    apt update && apt -y install python3-pip python3-setproctitle
    pip3 install odoopbx

Installation on CentOS
++++++++++++++++++++++

Versions 6&7
++++++++++++
First, you should enable and install Python3 and pip.

There are at least `3 ways to install the latest Python3 package on CentOS <https://www.2daygeek.com/install-python-3-on-centos-6/>`_. 

Below is one of them (IUS).

.. code:: 

    curl 'https://setup.ius.io/' -o setup-ius.sh
    sh setup-ius.sh
    yum --enablerepo=ius install python36 python36-pip python36-setproctitle
    pip3 install odoopbx

.. warning::

   Please note that if you are using FreePBX, which is based on Centos 7, it has a different Python3 naming schema,
   similar to ius, but using Sangoma's own repositories. You shouldn't try to use 3rd party repositories,
   simply run ``yum makecache`` to get latest information from Sangoma's repositories and install Python3 by running 
   ``yum install python36u python36u-pip``

Version 8
+++++++++
Latest CentOS is quite ready for Python3. So here are the installation steps:

.. code::

    yum install python3 python3-pip python3-devel
    pip3 install odoopbx


Sangoma Linux release 7.8
+++++++++++++++++++++++++

.. code::

    yum install python36u python36u-pip python36u-devel
    pip3.6 install odoopbx
    

Installation errors
###################
During ``odoopbx install agent`` execution the following log lines are expected and they are normal:

.. code::
 
 14:16:12 - salt.loaded.ext.module.asteriskmod:40 - ERROR - ipsetpy lib not found, asterisk module not available.
 14:16:12 - salt.loaded.ext.module.odoomod:23 - INFO - OdooRPC lib not found, odoo module not available.

This is because these packages are going to be installed exactly during this operation.

Odoo module installation
========================
Install Asterisk Plus module in the same way you install any other Odoo module.

Do a database backup before installation or upgrade and also make a backup of previous version of the module
if you have it (just in case to be able to restore quicky).


Requirements
############
The module dependencies are localed in ``requirements.txt`` file located in the module folder.

If you use odoo.sh make sure you copy the requirements to your modules top folder so that odoo.sh can 
install the required dependencies.

If you use python virtualenv make sure you install the requirements there and not system wide.


Configuration
#############
Odoo should be configured in the right way in order to be ready for Asterisk Plus.

Usually Odoo configuration file is located in ``/etc/odoo/odoo.conf`` but make sure
to use your environment configuration file.

Make sure that ``addons_path`` is set correctly to include Asterisk Plus modules.

Workers
+++++++
Workers are Odoo processes that handle requests.

Asterisk modules make many short-running requests.

So your Odoo should be configured with at least 2 workers 
(but 4 workers is the minimal recommended starting value).

.. warning:: 
    If you use odoo.sh with 1 worker configured it is possible to get issues related to performance.


Gevent process for long polling
+++++++++++++++++++++++++++++++
Internal gevent-based server must be enabled (aka long polling) for popup notifications
and live channels reload to work.

When you enable workers gevent server is also enabled.

By default port 8072 is used and you can check it with:

.. code::

    netstat -an | grep LISTEN | grep 8072

on your Odoo server.

If you don't use a proxy (apache / nginx / etc) then you should open Odoo
on gevent's port e.g.: ``http://127.0.0.1:8072/web``.

If you run Odoo behind a proxy be sure to add a different proxy handler for /longpolling/poll URL.

Here is a snippet for Nginx:

.. code::

    location /longpolling/poll {
      proxy_pass http://127.0.0.1:8072;
    }

If you see ``Exception: bus.Bus unavailable`` in your Odoo log then it means you
did not set long polling right.

Single / multi database setup
+++++++++++++++++++++++++++++
There is one thing your should know.

It's a good configuration when your Odoo is limited to just one database with dbfilter
configuration option and list_db set to False.

But when you run Odoo with multiple databases some special configuration must be enabled.

You should add asterisk_plus to **server_wide_modules** parameter in order to be able 
to make CURL requests from the Asterisk dialplan (see below).

Here is an example of such a configuration line:

.. code::

    server_wide_modules = web,asterisk_plus

Asterisk AMI configuration
==========================
You should prepare an Asterisk Manager Interface (AMI) account to allow the Agent to connect to Asterisk.

Vanilla Asterisk requires editing the  ``manager.conf`` file, which is usually found in ``/etc/asterisk``.

A sample configuration is provided below, which lets the Agent to connect
to your Asterisk server AMI port (usually 5038) using the login ``odoo`` with the password ``odoo``.


``manager.conf``:

.. code::

    [general]
    enabled = yes
    webenabled = no ; Asterisk calls does not use HTTP interface
    port = 5038
    bindaddr = 127.0.0.1

    [odoo]
    secret=odoo
    displayconnects = yes
    read=all
    write=all
    deny=0.0.0.0/0.0.0.0
    permit=127.0.0.1/255.255.255.0

Asterisk-based distributions such as **FreePBX**  offer a web GUI interface for managing your
AMI users. You can use that interface to create one, or you can add the account configuration data in
a custom file, which will not be managed by the distro, usually ``/etc/asterisk/manager_custom.conf``

.. warning::
   For security reasons always use deny/permit options in your manager.conf.
   Change permit option to IP address of your Asterisk server if agent is not started on the same box. 

Make sure that you applied new configuration by checking the Asterisk console:

.. code::
    
    manager show user odoo


The Agent Configuration
=======================
The Agent local configuration file is located in ``/etc/salt/minion_local.conf``.

The defaults are located in ``/etc/salt/minion.d/odoopbx.conf``.

When you add an option to the local configuration it overwrites the default value.

Odoo settings
#############
First configure the Agent's connection to Odoo:

.. code::

    odoopbx config set odoo_host 1.2.3.4 # Put IP address or hostname here.
    odoopbx config set odoo_port 8069 # If your Odoo is behind a proxy put 80 or 443 here.
    odoopbx config set odoo_bus_port 8072 # If your Odoo is behind a proxy put 80 or 443 here.
    odoopbx config set odoo_db demo # Put your database here
    odoopbx config set odoo_user asterisk # It's ok to leave the default user name.
    odoopbx config set odoo_password asterisk # This is the default password set on addon installation. CHANGE IT!!!
    odoopbx config set odoo_single_db false # Set to true if you have dbfilter or just one db.
    odoopbx config set odoo_use_ssl false # Set to true if your proxy servers HTTPS requests.

Asterisk AMI settings
#####################
Next we should configure the Agent for Asterisk connection.
Make sure you applied the Asterisk manager configuration first. 

Once you are sure the Odoo AMI user is operational run the following commands
to configure the Agent's connection
to your Asterisk:

.. code::

    odoopbx config set ami_host 127.0.0.1
    odoopbx config set ami_port 5038
    odoopbx config set ami_login odoo # Put here AMI user name you created in manager.conf.
    odoopbx config set ami_secret odoo # Put here AMI user password.

See ``/etc/salt/minion_local.conf`` to check that everything looks like expected.

Agent test run
==============

.. code::

    ; Stop the Agent service
    odoopbx stop agent
    ; Run in foreground
    odoopbx run agent

Check the Agent output printed on the screen. There should be no errors on start.

You should see messages that confirm both Odoo connection and Asterisk connection as shown below:

.. code::

   [INFO    ] salt.loaded.ext.engines.odoo_executor:48 Logged into Odoo.
   * * *
   [INFO    ] salt.loaded.ext.engines.asterisk_ami:69 AMI connecting to odoo@127.0.0.1:5038...
   [INFO    ] salt.loaded.ext.engines.asterisk_ami:72 Registering for AMI event *


Asterisk Dialplan configuration
===============================

Asterisk Plus exposes additional functionality by providing the following controllers:

#. You can get the contact's name by accessing ``asterisk_plus/get_caller_name?number=${CALLERID(number)}``
#. If the Contact for the phone number has a manager set, use ``asterisk_plus/get_partner_manager?number=${CALLERID(number)}`` to get the manager's number
#. You can get the Contact's tags by using ``/asterisk_plus/get_caller_tags?number=${CALLERID(number)}``

Here are some examples of integration, using Asterisk dialplans.


``extensions.conf``:

.. code::

    [globals]
    ODOO_URL=http://odoo:8069

    ; Set connection options for curl.
    [sub-setcurlopt]
    exten => _X.,1,Set(CURLOPT(conntimeout)=3)
    exten => _X.,n,Set(CURLOPT(dnstimeout)=3)
    exten => _X.,n,Set(CURLOPT(httptimeout)=3)
    exten => _X.,n,Set(CURLOPT(ssl_verifypeer)=0)
    exten => _X.,n,Return

    ; Partner's extension click2call e.g. +1234567890##101
    [post-dial-send-dtmf]
    exten => s,1,NoOp(DTMF digits: ${dtmf_digits})
    same => n,ExecIf($["${dtmf_digits}" = ""]?Return)
    same => n,Wait(${dtmf_delay})
    same => n,SendDTMF(${dtmf_digits})
    same => n,Return


    ;Set Caller ID name from Odoo
    ; Get caller ID name from Odoo, replace odoo to your Odoo's hostname / IP address
    ; Arguments:
    ; - number: calling number, strip + if comes with +.
    ; - db: Odoo's database name, ommit if you have one db or use dbfilter.
    ; - country: 2 letters country code, See https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
    ; If country code is omitted Asterisk Agent's Odoo account's country settings will be used for phonenumbers parsing.
    
    [sub-setcallerid]
    exten => _X.,1,Gosub(sub-setcurlopt,${EXTEN},1)
    ;   You need to cut leading + on numbers incoming from trunks before passing it to get_caller_name.
    exten => _X.,n,Set(CALLERID(name)=${CURL(${ODOO_URL}/asterisk_plus/get_caller_name?number=${CALLERID(number)})})
    exten => _X.,n,Return


    ; Get partner’s manager (salesperson) channel

    [sub-dialmanager]
    exten => _X.,1,Set(manager_channel=${CURL(${ODOO_URL}/asterisk_plus/get_partner_manager?number=${CALLERID(number)})})
    exten => _X.,n,ExecIf($["${manager_channel}" != ""]?Dial(${manager_channel}/${EXTEN},60,t))
    exten => _X.,n,Return
    
    ; Get partner's tags to create a special call routing (e.g. VIP queue)
    ; You can also get caller tags from Odoo with the following controller Here is an example:
    
    ; Partner tags
    ; VIP - tag name in this example.

    [partner-vip-tag-lookup] 
    exten => _X.,1,Set(CURLOPT(conntimeout)=3)
    exten => _X.,n,Set(CURLOPT(dnstimeout)=3)
    exten => _X.,n,Set(CURLOPT(httptimeout)=3)
    exten => _X.,n,Set(CURLOPT(ssl_verifypeer)=0)
    exten => _X.,n,Set(tags=${CURL(${ODOO_URL}/asterisk_plus/get_caller_tags?number=${CALLERID(number)})})
    exten => _X.,n,NoOp(Tags: ${tags})
    exten => _X.,n,Set(match=${REGEX("VIP" ${tags})})
    exten => _X.,n,NoOp(Match: ${match})
    exten => _X.,n,Return(${match})

    ; Check VIP tag
    [check-vip]
    exten => _X.,1,Gosub(partner-vip-tag-lookup,${EXTEN},1,VIP)
    exten => _X.,n,GotoIf($["${GOSUB_RETVAL}" = "1"]?vip-queue,${EXTEN},1)


    ; Incoming call handling

    [from-sip-external]    
    exten => _X.,1,Gosub(sub-setcallerid,${EXTEN},1) ; Set partner's caller name    
    exten => _X.,n,MixMonitor(${UNIQUEID}.wav) ; Record call    
    exten => _X.,n,Gosub(sub-dialmanager,${EXTEN},1) ; Try to connect to manager
    ; Put here some login to handle if manager channel is busy for example put in the queue.
    exten => _X.,n,Queue(sales)

    [from-internal]
    exten => _X.,1,MixMonitor(${UNIQUEID}.wav) ; Activate call recording.
    exten => _XXXX,2,Dial(SIP/${EXTEN},30) ; Local users calling    
    exten => _XXXXX.,2,Dial(SIP/provider/${EXTEN},30,TU(post-dial-send-dtmf) ; Outgoing calls pattern

That's all for now!
